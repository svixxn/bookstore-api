FROM node:24-alpine

WORKDIR /app

# Copy package files first for better layer caching
COPY package*.json ./
COPY nest-cli.json tsconfig*.json ./

# Install dependencies
RUN npm install
RUN npm install -g @nestjs/cli

# Copy source code
COPY prisma ./prisma
COPY apps ./apps
COPY libs ./libs

# Generate Prisma client
RUN npx prisma generate

# Set development environment
ENV NODE_ENV=development

EXPOSE 3002

# Run database migrations and start development server
CMD ["npm", "run", "migrate:start:dev:books"]
